<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Fatebook – Glen Cooney</title> <meta name="description" content="Welcome to my official portfolio site"> <meta name="keywords" content="Bloc, Frontend, Backend, Fullstack, Angular, Rails, Capstone"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://127.0.0.1:4000//assets/img/meface_no-border.png"> <meta name="twitter:title" content="Fatebook"> <meta name="twitter:description" content="App for creating and sharing interactive stories"> <meta name="twitter:site" content="@transplanar"> <meta name="twitter:creator" content="@transplanar"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Fatebook"> <meta property="og:description" content="App for creating and sharing interactive stories"> <meta property="og:url" content="http://127.0.0.1:4000//Fatebook/"> <meta property="og:site_name" content="Glen Cooney"> <meta property="og:image" content="http://127.0.0.1:4000//assets/img/meface_no-border.png"> <link rel="canonical" href="http://127.0.0.1:4000//Fatebook/"> <link href="http://127.0.0.1:4000//feed.xml" type="application/atom+xml" rel="alternate" title="Glen Cooney Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://127.0.0.1:4000//assets/css/main.css"> <!-- JS --> <script src="http://127.0.0.1:4000//assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://127.0.0.1:4000//assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://127.0.0.1:4000//assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://127.0.0.1:4000//assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://127.0.0.1:4000//assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://127.0.0.1:4000//favicon.png"> <link rel="shortcut icon" href="http://127.0.0.1:4000//favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(http://127.0.0.1:4000//assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://127.0.0.1:4000//">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://127.0.0.1:4000//assets/img/meface_no-border.png" alt="Glen Cooney photo" class="author-photo"> <h4>Glen Cooney</h4> <p>Welcome to my official portfolio site</p> </li> <li><a href="http://127.0.0.1:4000//about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:glen@glencooney.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/transplanar" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/glencooney" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/transplanar" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://stackoverflow.com/users/5031910/glen-cooney" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://127.0.0.1:4000//posts/">All Posts</a></li> <li><a href="http://127.0.0.1:4000//tags/">All Tags</a></li> </ul> </li> <li><a href="http://127.0.0.1:4000//projects/">Projects</a></li> <li><a href="http://127.0.0.1:4000//contact/">Contact</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Fatebook</h1> <h4>26 Jul 2016</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~11 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://127.0.0.1:4000//projects/"> <i class="fa fa-chevron-left" style="font-size: 1.5rem"></i> </a> <!-- REVIEW FIXME messed up display of heroku icon --> <span> <div class="social-btn"> <a class="fa fa-fw fa-globe" style="font-size: 1.5rem" href="" title="View on Heroku"></a> </div>
<div class="social-btn"> <a style="font-size: 1.5rem" class="fa fa-fw fa-github" href="https://github.com/transplanar/Fatebook" title="View on Github"></a> </div> </span> </div> <!-- NOTE standardize code samples by including file name in bold --> <h1 id="the-project">The Project</h1> <p><em>Fatebook is a social platform for creating and sharing interactive, choose-your-own-adventure stories. As an Angular on Rails application, it is the culmination of my Rails and Angular studies through Bloc.</em></p> <h3 id="tools">Tools</h3> <p><a href="http://rubyonrails.org/">Rails</a>, <a href="https://www.javascript.com/">Javascript</a>, <a href="https://angularjs.org/">Angular</a>, <a href="https://github.com/angular-ui/ui-router">UI-Router</a>, <a href="https://docs.angularjs.org/api/ngCookies">ngCookies</a>, <a href="https://github.com/rails-api/active_model_serializers">ActiveModelSerializers</a>, <a href="http://underscorejs.org/">Underscore.js</a>, <a href="http://ckeditor.com/">ckEditor</a>, <a href="http://getbootstrap.com/">Bootstrap</a>, <a href="https://atom.io/">Atom</a>, <a href="http://www.ubuntu.com/">Ubuntu</a></p> <h1 id="the-app">The App</h1> <p><em>Upon entering the app, users are able to play through any existing published story. When playing through a story, they will see a paragraph or two of text, followed my a set of options. Each option will take the user down a new story thread. Users may select these chooses by clicking or pressing the corresponding number on their keyboard.</em></p> <p><em>Should a user want to create their own story, they must log in and select “create story”. From here they can provide a title and description of their story. Upon creating the story, the first page is automatically generated. After populating the content of the page, they can click “create option” to define a new option players can choose. They can then click the “Edit Page” button for that new option to go directly to a page generated for that option.</em></p> <p><em>At any time, users can use the buttons along the top to navigate to the parent page, parent story, or view sibling stories on the same level of the story tree. Additionally, users may view the story tree at the bottom of the page, allowing them to easily traverse their story and identify which story threads remain unfinished.</em></p> <h1 id="the-process">The Process</h1> <p><em>While planning the project, I defined two main states: Play mode, where a user is playing through someone’s story, and Edit mode, where a user is creating or editing one of their own stories.</em></p> <p><em>I began with the Play state, starting initially as a pure Angular application. I created a system where a <code class="highlighter-rouge">Story</code> object would contain an array of <code class="highlighter-rouge">Pages</code>. Each <code class="highlighter-rouge">Page</code> would contain an array of <code class="highlighter-rouge">choices</code>, which would be an object hash with the attributes of <code class="highlighter-rouge">text</code> for the text of the choice the users sees, and <code class="highlighter-rouge">dest</code> for the ID of the destination page.</em></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Page</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">parentPage</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">parentPage</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
   <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">summary</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">summary</span><span class="p">;</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">choices</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">choices</span><span class="p">;</span> <span class="c1">//Displayed to user</span>

     <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">createChildPages</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
     <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">choices</span><span class="p">){</span>
       <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">choices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
         <span class="kd">var</span> <span class="nx">newPageID</span> <span class="o">=</span> <span class="nx">getBranchID</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
         <span class="nx">createPlaceholderPage</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">newPageID</span><span class="p">);</span>

         <span class="k">this</span><span class="p">.</span><span class="nx">choices</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">dest</span> <span class="o">=</span> <span class="nx">newPageID</span><span class="p">;</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
 <span class="p">};</span></code></pre></figure> <p><em>To make nested seeding of page data easier, I used a page ID system I came up with for a short branching story I wrote years ago called Doors (which I ended up using as the example story for my app.) The naming convention consisted of alternating numbers and letters to indicate the number of levels down through the story a user had navigated. For example, the first page would have a <code class="highlighter-rouge">id</code> of “1”, with child pages of “1A” and “1B”. This could be chained indefinitely, so a page like “1A2B2” would be the child of page “1A2B” and sibling to “1A2B1”.</em></p> <p><em>This <code class="highlighter-rouge">id</code> was auto-generated using the following code (annotations added as comments):</em></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">getBranchID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">index</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">parent</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">idString</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">lastChar</span> <span class="o">=</span> <span class="nx">idString</span><span class="p">[</span><span class="nx">idString</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">//Uses a regular expression to test if last character</span>
    <span class="c1">// of parent pageID is a number or letter</span>
    <span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">\d</span><span class="sr">+$/</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">reg</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">lastChar</span><span class="p">)){</span>
      <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="nx">indexToAlpha</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="k">return</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="p">(</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p><em>Using this <code class="highlighter-rouge">id</code> system and the functions built into the <code class="highlighter-rouge">Page</code> object, I set up a system for easily populating a test array of pages. To do this, I first created a dummy first page, then used an <code class="highlighter-rouge">editPage</code> function I created to create an repeatable format I could use to populate all pages.</em></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">editPage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">args</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">getPageFromID</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">page</span><span class="p">){</span>
    <span class="nx">page</span>
      <span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">createChildPages</span><span class="p">();</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">'Attempt to edit with invalid page id "'</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">'" SKIPPING'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">...</span>

<span class="nx">createPlaceholderPage</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">=</span> <span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">currentStory</span><span class="p">.</span><span class="nx">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="nx">StoryNavSrv</span>
  <span class="p">.</span><span class="nx">editPage</span><span class="p">(</span><span class="s1">'1'</span><span class="p">,</span>
     <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Initial page'</span><span class="p">,</span>
        <span class="na">summary</span><span class="p">:</span> <span class="s1">'First page'</span><span class="p">,</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'You see two doors. Which do you choose?'</span><span class="p">,</span>
        <span class="na">choices</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span><span class="na">text</span><span class="p">:</span> <span class="s1">'Left door'</span><span class="p">},</span>
          <span class="p">{</span><span class="na">text</span><span class="p">:</span> <span class="s1">'Right door'</span><span class="p">}</span>
        <span class="p">],</span>
      <span class="p">});</span>
<span class="nx">StoryNavSrv</span>
  <span class="p">.</span><span class="nx">editPage</span><span class="p">(</span><span class="s1">'1A'</span><span class="p">,</span>
     <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Left door'</span><span class="p">,</span>
      <span class="na">summary</span><span class="p">:</span> <span class="s1">'First page'</span><span class="p">,</span>
      <span class="na">content</span><span class="p">:</span> <span class="s1">'You entered the LEFT door.'</span><span class="p">,</span>
    <span class="p">});</span>
<span class="nx">StoryNavSrv</span>
  <span class="p">.</span><span class="nx">editPage</span><span class="p">(</span><span class="s1">'1B'</span><span class="p">,</span>
     <span class="p">{</span>
      <span class="na">title</span><span class="p">:</span> <span class="s1">'Left door'</span><span class="p">,</span>
      <span class="na">summary</span><span class="p">:</span> <span class="s1">'First page'</span><span class="p">,</span>
      <span class="na">content</span><span class="p">:</span> <span class="s1">'You entered the RIGHT door.'</span><span class="p">,</span>
      <span class="na">choices</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="na">text</span><span class="p">:</span> <span class="s1">'Or did I?'</span><span class="p">},</span>
        <span class="p">{</span><span class="na">text</span><span class="p">:</span> <span class="s1">'No I didn\'t'</span><span class="p">},</span>
      <span class="p">],</span>
    <span class="p">});</span>
<span class="p">...</span></code></pre></figure> <p><em>With a working story navigation system working, I decided to add in keyboard controls as well.</em></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">'keyup'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">currentPage</span> <span class="o">&amp;&amp;</span> <span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">currentPage</span><span class="p">.</span><span class="nx">choices</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">choiceIndex</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">-</span> <span class="mi">49</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">StoryNavSrv</span><span class="p">.</span><span class="nx">currentPage</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">choice</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">choices</span><span class="p">[</span><span class="nx">choiceIndex</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">choice</span><span class="p">){</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">setPage</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">dest</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure> <p><em>With a working frontend implementation, I then moved on to add a Rails backend. Following a guide I found on youtube, I was able to get Angular to communicate with Rails, though it was a tricky process. I had to do some research to find the gems I required, namely <code class="highlighter-rouge">angular-rails-templates</code> to enable my Angular templates to be used in the Rails asset pipeline.</em></p> <p><em>My Rails backend became an API to store and pass data to Angular via the UI-Router service. It accomplished this by passing returning JSON to my Frontend, after being processed by the appropriate <code class="highlighter-rouge">ActiveModelSerializer</code> to ensure the relevant attributes were properly passed.</em></p> <p><em>It took me a little while to make sense of creating these accessor services, but eventually it clicked and made sense how the urls they used corresponded to the routes created by Rails.</em></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="kd">function</span> <span class="nx">PageSrv</span><span class="p">(</span><span class="nx">$resource</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">'/pages/:id.json'</span><span class="p">,</span> <span class="p">{</span><span class="na">id</span><span class="p">:</span> <span class="s1">'@id'</span><span class="p">},</span>
    <span class="p">{</span>
      <span class="na">query</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="na">isArray</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
      <span class="na">create</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">},</span>
      <span class="na">show</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">},</span>
      <span class="na">update</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'PUT'</span><span class="p">},</span>
      <span class="na">delete</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'DELETE'</span><span class="p">},</span>
      <span class="na">first</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="na">url</span><span class="p">:</span> <span class="s1">'/pages/get_first_page/:story_id'</span><span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">angular</span>
    <span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'fatebook'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'PageSrv'</span><span class="p">,[</span><span class="s1">'$resource'</span><span class="p">,</span> <span class="nx">PageSrv</span><span class="p">])</span>
<span class="p">})()</span></code></pre></figure> <p><em>I hit some friction coming up with the best approach for setting up the <code class="highlighter-rouge">ActiveRecord</code> associations between Stories, Pages, and child Pages. My initial thought was to create a <code class="highlighter-rouge">has_many :through</code> relationship, using a <code class="highlighter-rouge">branch</code> model to link a parent page to a destination page. This created an odd situation where each page <code class="highlighter-rouge">has_many</code> pages and <code class="highlighter-rouge">belongs_to</code> a parent page, which just wasn’t working right.</em></p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Page</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:story</span>
  <span class="n">has_many</span> <span class="ss">:branches</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">'Page'</span><span class="p">,</span> <span class="ss">foreign_key: :parent_id</span>
  <span class="n">belongs_to</span> <span class="ss">:parent_page</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">'Page'</span><span class="p">,</span> <span class="ss">foreign_key: :parent_id</span>
<span class="k">end</span></code></pre></figure> <p><em>After some thought and consultation with my mentor, I realized there was a better approach. Rather than having pages be linked to each other directly, I could instead define a <code class="highlighter-rouge">Branch</code> join table to link pages together. The result was a much cleaner association.</em></p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Page</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:story</span>
  <span class="n">has_many</span> <span class="ss">:branches</span><span class="p">,</span> <span class="ss">foreign_key: :parent_id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Branch</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:story</span>
  <span class="n">belongs_to</span> <span class="ss">:parent_page</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">'Page'</span><span class="p">,</span> <span class="ss">foreign_key: :parent_id</span>
  <span class="n">belongs_to</span> <span class="ss">:destination_page</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s1">'Page'</span><span class="p">,</span> <span class="ss">foreign_key: :destination_id</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span></code></pre></figure> <p><em>With the associations created, I set to out to seed the database with a full, branching story I wrote back in 2007. Using the naming conventions I set up before, I was able to fairly easily import my story into the database page by page. While no longer functionally required, I used a similar naming convention for <code class="highlighter-rouge">Pages</code> to keep track of which stories were connected to each other, using a <code class="highlighter-rouge">create_branch</code> method to link them together in the database.</em></p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">create_branch</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span>
  <span class="n">parent</span> <span class="o">=</span> <span class="no">Page</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>

  <span class="n">branch</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="nf">branches</span><span class="p">.</span><span class="nf">create!</span><span class="p">({</span>
    <span class="ss">destination_id: </span><span class="n">child</span><span class="p">[</span><span class="ss">:id</span><span class="p">],</span>
    <span class="ss">choice_text: </span><span class="n">child</span><span class="p">[</span><span class="ss">:text</span><span class="p">]</span>
  <span class="p">})</span>

  <span class="n">story</span> <span class="o">=</span> <span class="vi">@user</span><span class="p">.</span><span class="nf">stories</span><span class="p">.</span><span class="nf">first</span>
  <span class="n">story</span><span class="p">.</span><span class="nf">branches</span> <span class="o">&lt;&lt;</span> <span class="n">branch</span>
<span class="k">end</span>

<span class="o">---</span>

<span class="vi">@A1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">text: </span><span class="s1">'Super Mega Awesome Soda'</span><span class="p">,</span> <span class="ss">id: </span><span class="n">story</span><span class="p">.</span><span class="nf">pages</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="ss">title: </span><span class="s1">'The Taste of Super Mega Awesome Soda'</span><span class="p">,</span>
      <span class="ss">content: </span><span class="s2">"The moment the delectable fluid touches your tongue you are overwhelmed
       with a magical flavor sensation that makes every nerve in your body radiate with blissful
        satisfaction. After savoring the flavor you open you eyes and you are staring down a hideous
         man-beast twice your size and thrice your width. He doesn't look too happy. What do you say?"</span>
    <span class="p">}</span>
    <span class="p">).</span><span class="nf">id</span>
  <span class="p">}</span>
<span class="n">create_branch</span><span class="p">(</span><span class="vi">@A1</span><span class="p">,</span> <span class="vi">@A</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span></code></pre></figure> <p><em>For each <code class="highlighter-rouge">Page</code>, I created a hash containing the choice text and reference to the page ID (combining the page initialization and id getter into a single statement for brevity). <code class="highlighter-rouge">create_branch</code> would then take this new object and use it to define the child page for the parent page via a branch.</em></p> <p><em>On the parent page (from the second parameter), a new branch would be created, passing in the choice text (<code class="highlighter-rouge">choice_text</code>) of the child object as well as the id of the associated child page (<code class="highlighter-rouge">destination_id</code>). To ensure all branches are associated with the correct <code class="highlighter-rouge">Story</code>, the new branch is associated with the story’s branch collection via the shovel operator.</em></p> <p><em>Returning to the view, I wanted to ensure the author was able to easily navigate through the pages of their story. I decided to add buttons to allow a user to quickly navigate to the parent page, parent story, and sibling stories. To do this, I had to create a system to ensure any given page rendered routed to the appropriate page.</em></p> <p><em>To do this, I created a few additional routes for my <code class="highlighter-rouge">BranchSrv</code> service, integrated with the Rails <code class="highlighter-rouge">BranchesController</code>:</em></p> <p><strong>PageEditCtrl.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">BranchSrv</span><span class="p">.</span><span class="nx">findPageByDestination</span><span class="p">({</span><span class="na">id</span><span class="p">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">id</span><span class="p">}).</span><span class="nx">$promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">fromChoiceText</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">choice_text</span><span class="p">;</span>
    <span class="nx">initParentPage</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">parent_id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></code></pre></figure> <p><strong>BranchSrv.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">BranchSrv</span><span class="p">(</span><span class="nx">$resource</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">'/branches/find_by_destination/:id'</span><span class="p">,{},</span>
  <span class="p">{</span>
    <span class="na">findPageByDestination</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">},</span>
    <span class="na">query</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span> <span class="na">isArray</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">url</span><span class="p">:</span><span class="s1">'/branches'</span><span class="p">},</span>
    <span class="na">delete</span><span class="p">:</span> <span class="p">{</span><span class="na">method</span><span class="p">:</span> <span class="s1">'DELETE'</span><span class="p">,</span>  <span class="na">url</span><span class="p">:</span><span class="s1">'/branches/:id'</span><span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure> <p><strong>branches_controller.rb</strong></p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">find_by_destination</span>
  <span class="vi">@branch</span> <span class="o">=</span> <span class="no">Branch</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">destination_id: </span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>

  <span class="n">render</span> <span class="ss">json: </span><span class="vi">@branch</span>
<span class="k">end</span></code></pre></figure> <p><em>Getting sibling pages was comparably simpler, as that only involved looping through the branches of the parent page.</em></p> <p><strong>PageEditCtrl.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">initSiblingPages</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">$scope</span><span class="p">.</span><span class="nx">siblingPages</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">parentPage</span><span class="p">.</span><span class="nx">branches</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">branch</span><span class="p">){</span>
    <span class="nx">PageSrv</span><span class="p">.</span><span class="nx">show</span><span class="p">({</span><span class="na">id</span><span class="p">:</span> <span class="nx">branch</span><span class="p">.</span><span class="nx">destination_id</span><span class="p">}).</span><span class="nx">$promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
      <span class="nx">$scope</span><span class="p">.</span><span class="nx">siblingPages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></code></pre></figure> <p><em>While navigation between pages was functional, I still felt the linear display of pages within a story wasn’t visually appealing or useful to users. Thus I set out to create a tree view that would render out all the pages, visually displaying the various story paths a player could go down.</em></p> <p><em>To do this, I used a recursive function to populate a multidimensional <code class="highlighter-rouge">tree</code> array, then a recursive Angular template to render it out.</em></p> <p><strong>StoryEditCtrl.js</strong></p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">getTree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">page</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">tree</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">branches</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">branches</span><span class="p">,</span> <span class="p">{</span><span class="na">parent_id</span><span class="p">:</span> <span class="nx">page</span><span class="p">.</span><span class="nx">id</span><span class="p">});</span>
  <span class="kd">var</span> <span class="nx">pages</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">branches</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">branch</span><span class="p">){</span> <span class="k">return</span> <span class="nx">branch</span><span class="p">.</span><span class="nx">destination_page</span> <span class="p">});</span>

  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">pages</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">page</span><span class="p">){</span>
    <span class="nx">tree</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="na">page</span><span class="p">:</span> <span class="nx">page</span><span class="p">,</span> <span class="na">children</span><span class="p">:</span> <span class="nx">getTree</span><span class="p">(</span><span class="nx">page</span><span class="p">)});</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">tree</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure> <p><strong>branch_tree.html.erb</strong></p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">'data in tree'</span> <span class="na">ng-include=</span><span class="s">"'tree_element_renderer.html'"</span><span class="nt">&gt;</span> <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre></figure> <p><strong>tree_element_renderer.html.erb</strong></p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'btn btn-warning'</span> <span class="na">ui-sref=</span><span class="s">'edit_page({story_id: currentStory.id, page_id: data.page.id } )'</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">'btn btn-danger'</span> <span class="na">ng-hide=</span><span class="s">'data.page.complete'</span><span class="nt">&gt;</span>Incomplete<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">'data in data.children'</span> <span class="na">ng-include=</span><span class="s">"'tree_element_renderer.html'"</span><span class="nt">&gt;</span> <span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span></code></pre></figure> <p><em>With these navigation features implemented, I moved on to adding a User system. For the sake of the project, I kept the user system fairly simple, allowing easy signup and login without special authorization or authentication. This was done to constrain the focus of my project to its core features, though it is an area I intend to revist in the future.</em></p> <p><em>The User system primarily served as a means to associate stories with their authors. Whenever a User creates a Story, by default the story is not published. When a User clicks the button to save their story as published (via their <code class="highlighter-rouge">published</code> boolean attribute), then it will be visible to all Users. By the same token, <code class="highlighter-rouge">Pages</code> can be saved as finished or unfinished, and a Story cannot be published until all its child pages are marked as finished (via their <code class="highlighter-rouge">finished</code> boolean attribute).</em></p> <p><em>With these features implemented, all that remained was styling, cookies, and integration of ckEditor for text editing, which were comparably straightforward.</em></p> <h1 id="the-outcome">The Outcome</h1> <p><em>As intended, this proved to be my most challenging and sophisticated project to date. While I felt I had a solid handle on Angular going into the project, integrating it with a Rails backend took some effort and research to tailor my code to work with it. Once I understood how <code class="highlighter-rouge">ngResource</code> queried the routes generated by Rails, the connection clicked, and it became much easier to work with.</em></p> <p><em>The best way to set up my <code class="highlighter-rouge">Page</code> and <code class="highlighter-rouge">Branch</code> associations was something I agonized over for a while, but ultimately what cemented my decision was the question of flexibility. If a page directly knew its parents and children, then that would mean the path to any given page would be fixed. Hypothetically, a user may want to have certain choices lead back to an existing page, and I wanted to be able to support that. In its present form, my app has no easy way for players to do this, but I made the decision with an eye for where I want to take the app in its future incarnations.</em></p> <h1 id="the-future">The Future</h1> <p><em>As with <a href="/dset/">DSet</a>, I created this app as a proof of concept of a larger app I intend to build. My ultimate goal is to create a platform for users to create and share not only choose-your-own-adventure stories, but text-based games complete with dice rolling mechanics, inventory, and even multiplayer. This app marks the first step down that road, laying out the core functionality for future development.</em></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://127.0.0.1:4000//tags/#Bloc" title="Pages tagged Bloc" class="tag"><span class="term">Bloc</span></a><a href="http://127.0.0.1:4000//tags/#Frontend" title="Pages tagged Frontend" class="tag"><span class="term">Frontend</span></a><a href="http://127.0.0.1:4000//tags/#Backend" title="Pages tagged Backend" class="tag"><span class="term">Backend</span></a><a href="http://127.0.0.1:4000//tags/#Fullstack" title="Pages tagged Fullstack" class="tag"><span class="term">Fullstack</span></a><a href="http://127.0.0.1:4000//tags/#Angular" title="Pages tagged Angular" class="tag"><span class="term">Angular</span></a><a href="http://127.0.0.1:4000//tags/#Rails" title="Pages tagged Rails" class="tag"><span class="term">Rails</span></a><a href="http://127.0.0.1:4000//tags/#Capstone" title="Pages tagged Capstone" class="tag"><span class="term">Capstone</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://127.0.0.1:4000//Fatebook/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Like</span> </a> <a href="https://twitter.com/intent/tweet?text=http://127.0.0.1:4000//Fatebook/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://127.0.0.1:4000//Fatebook/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="http://127.0.0.1:4000//assets/js/jquery-1.12.0.min.js"></script> <script src="http://127.0.0.1:4000//assets/js/jquery.dlmenu.min.js"></script> <script src="http://127.0.0.1:4000//assets/js/jquery.goup.min.js"></script> <script src="http://127.0.0.1:4000//assets/js/jquery.magnific-popup.min.js"></script> <script src="http://127.0.0.1:4000//assets/js/jquery.fitvid.min.js"></script> <script src="http://127.0.0.1:4000//assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-81619796-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
